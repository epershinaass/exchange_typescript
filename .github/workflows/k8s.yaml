name: K8s
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Define branch name'
        required: true
        default: 'main'
        type: string
      service:
        description: 'Service to build'
        required: true
        type: choice
        options:
        - facade
        - balance
        - account
        - products
        - order
      docker_tag:
        description: 'Docker tag'
        required: true
        type: string

jobs:
  build-image:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      IMAGE_REGISTRY: ${{ secrets.REGISTRY }} # epershinaass2.jfrog.io
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        ref: ${{ inputs.branch }}

    - name: Set up Docker Buildx üêã
      uses: docker/setup-buildx-action@v2

    - name: Login to JFrog üê∏
      uses: docker/login-action@v1
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ secrets.JFROG_USERNAME_BUILD_USERNAME }}
        password: ${{ secrets.JFROG_USERNAME_BUILD_ACCESS_TOKEN }}

    - name: Upload Dockerfile as artifact
      if: inputs.service != 'facade'
      uses: actions/upload-artifact@v3
      with:
        name: dockerfile-artifact
        path: Dockerfile
        retention-days: 1

    - name: Download artifact from previous workflow
      if: inputs.service != 'facade'
      uses: actions/download-artifact@v3
      with:
        name: dockerfile-artifact
        path: /tmp

    - name: Changee kafka url
      if: ${{ (inputs.service != 'facade') || (inputs.service != 'account') }}
      env:
        KAFKA_URL: "'kafka-cluster-kafka-brokers.kafka:9092'"
      run: |
        sed -i -E -e "s/brokers: \[.*\],$/brokers: \[$KAFKA_URL\],/" ./${{ inputs.service }}/src/config/kafka.config.ts
        grep -e brokers ./${{ inputs.service }}/src/config/kafka.config.ts
