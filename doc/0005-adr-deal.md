# 3.1 Создание заявки на покупку и продажу товаров пользователем.

Дата: 2022-08-16

## Статус: PROPOSED

## Требование

### Создание заявки на продажу товара
1. Сделка совершается автоматически, когда найдена заявка на продажу и заявка на покупку с одинаковыми условиями: наименование товара, цена. 
2. Если у пользователя недостаточно средств на демо-счёте, то он не может совершить сделку. ??? Ну если он смог сделать заявку, значит у него достаточно средств
3. Во время сделки биржа получает 1% (разработчик может менять размер комиссии) от прибыли. ??? Со стороны сервера не так важно на каком этапе мы возьмем наш %
4. Если несколько заявок подходят по условиям, то сделка совершается с тем пользователем, который опубликовал заявку первым.
5. Если пользователь хочет удовлетворить условия в заявле полностью одной сделкой, то он может поставить галочку напротив ‘Продать всё сразу, либо не совершать сделку’ или ‘Купить всё сразу, либо не совершать сделку’ ??? Оставим на потом? или сделать сначала закрытие полных сделок, ибо они немного проще.
6. Также сделка может удовлетворяться частично разными пользователями при покупке/продаже товара одного наименования, при этом автоматически изменяется количество товара в заявке. Пример 1: пользователь хочет купить 100уе товара, другой пользователь может продать 20уе такого же товара, тогда сделка совершается, и в заявке на покупку изменяется объем товара на 80уе. Пример 2: пользователь хочет продать 100уе товара, другой пользователь хочет купить только 40уе такого же товара, тогда сделка совершается, и в заявке на продажу объем товара меняется 60уе. ??? на время свершения операции необходимо будет снижать количество/скрывать зявки в стакане

[Ссылка на исходный документ > 3.1-3.3](https://docs.google.com/document/d/1HwW4-Q8kIadQPA3vRosXDwSpWbfjIRJMwdgL5OhvnXY/edit#bookmark=id.sgjzva4uipp9)

## Решение

Реализовать функционал для свершения сделок. Он будет реализован как ??? часть ??? микросервиса заявок.

### Порядок передачи сообщений

Каждый раз, когда мы публикуем заявку, мы смотрим на наличие подходящих\более выгодных заявок противоположного типа.
Если такие есть, выбираем заявку с самой ранней датой.
Теперь можно начинать транзакцию:
1. Скрываем из стакана заявку с которой сошлись. ??? должны ли мы публиковать нашу заявку перед этим, или если кандидат нашелся?
2. Пишем в кафку сообщение содержащее данные о товаре и денежных средствах.
3. Сервисы продуктов читают сообщения и применяют изменения у себя.
Если на каком то этапе что то пошло не так, то откатываемся назад с помощью saga ??? 2pc

Также необходимо предусмотреть систему вычета % и возврата части денежных средств если противоположная заявка оказалась более выгодной.

## Передача сообщений

```ts
enum DealStatus {
  FAILED;
  PROCESSING;
  DONE;
}


Order {
  status: DealStatus;
  sellOrder: Order;
  buyOrder: Order;
}
```

## Альтернатива

Что бы написать этот раздел, обратите внимание на ???

## Заключение

Здесь был описан механизм свершения сделок.